/*
 * p8audio_test.s
 * Simple 68K test program for p8audio integration
 * 
 * This program:
 * 1. Sets up p8audio registers
 * 2. Triggers SFX 8 on channel 0
 * 3. Waits for completion
 * 4. Updates post_code to signal progress
 */

    .section .text
    .global _start

/* p8audio register addresses */
.equ P8AUDIO_BASE,      0x800100
.equ CTRL,              0x800102
.equ SFX_BASE_HI,       0x800104
.equ SFX_BASE_LO,       0x800106
.equ NOTE_ATK,          0x800110
.equ NOTE_REL,          0x800112
.equ SFX_CMD,           0x800114
.equ SFX_LEN,           0x800116

/* Post code output (via GPIO) */
.equ POST_CODE,         0x80000C

_start:
    /* Initialize stack pointer */
    move.l  #0x00001000, %sp

    /* Signal: Initializing p8audio (post_code = 3) */
    move.b  #3, POST_CODE

    /* Configure SFX base address using sfx_data label */
    move.l  #sfx_data, %d0         /* Load address of sfx_data into d0 */
    swap    %d0                    /* Get upper 16 bits */
    move.w  %d0, SFX_BASE_HI       /* Store upper 16 bits */
    move.l  #sfx_data, %d0         /* Reload address */
    move.w  %d0, SFX_BASE_LO       /* Store lower 16 bits */

    /* Enable p8audio: CTRL.RUN = 1 */
    move.w  #0x0001, CTRL

    /* Set note attack time = 20 */
    move.w  #20, NOTE_ATK

    /* Set note release time = 20 */
    move.w  #20, NOTE_REL

    /* Signal: Configuration complete (post_code = 4) */
    move.b  #4, POST_CODE

    /* Trigger SFX 8 on channel 0 with full length
     * SFX_CMD format:
     *   Bit 15:    Command valid (1)
     *   Bits 14-12: Channel (0 = channel 0)
     *   Bits 11-6:  Offset (0)
     *   Bits 5-0:   SFX index (8)
     */
    move.w  #0x8008, SFX_CMD       /* 1000_0000_0000_1000 */

    /* Set SFX length = 0 (play full SFX) */
    move.w  #0, SFX_LEN

    /* Signal: SFX triggered (post_code = 5) */
    move.b  #5, POST_CODE

    /* Wait a bit for SFX to play */
    move.l  #0x100000, %d0
wait_loop:
    subq.l  #1, %d0
    bne     wait_loop

    /* Signal: Test complete (post_code = 6) */
    move.b  #6, POST_CODE

    /* Loop forever */
infinite_loop:
    nop
    bra     infinite_loop

/* Reset vectors at beginning of ROM */
    .section .vectors, "a"
    .long   0x00001000      /* Initial SP */
    .long   _start          /* Initial PC */

/* SFX data */
    .section .rodata
    .align  64          /* Align on 64-byte boundary */
sfx_data:
    .byte 0x00, 0x0a, 0x0c, 0x0a, 0x18, 0x0a, 0x24, 0x0a, 0x30, 0x0a, 0x3c, 0x0a, 0x30, 0x0a, 0x24, 0x0a
    .byte 0x18, 0x0a, 0x0c, 0x0a, 0x00, 0x0a, 0x00, 0x00, 0x4c, 0x0a, 0x58, 0x0a, 0x64, 0x0a, 0x70, 0x0a
    .byte 0x7c, 0x0a, 0x70, 0x0a, 0x64, 0x0a, 0x58, 0x0a, 0x4c, 0x0a, 0x00, 0x00, 0x98, 0x0a, 0xa4, 0x0a
    .byte 0xb0, 0x0a, 0xbc, 0x0a, 0xb0, 0x0a, 0xa4, 0x0a, 0x98, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x08, 0x00, 0x00
    .byte 0x00, 0x06, 0x08, 0x0a, 0x0e, 0x12, 0x16, 0x1c, 0x1c, 0x1e, 0x1e, 0x20, 0x20, 0x1c, 0x1c, 0x20
    .byte 0x1e, 0x1a, 0x14, 0x0e, 0x0a, 0x06, 0x02, 0xfe, 0xfc, 0xfa, 0xf8, 0xf6, 0xf4, 0xf2, 0xf0, 0xee
    .byte 0xec, 0xec, 0xea, 0xea, 0xe8, 0xea, 0xee, 0xf2, 0xf6, 0xf8, 0xfc, 0xfe, 0x04, 0x08, 0x0e, 0x16
    .byte 0x1a, 0x22, 0x26, 0x28, 0x2a, 0x2a, 0x26, 0x26, 0x24, 0x1a, 0x1a, 0x16, 0x14, 0x12, 0x0e, 0x06
    .byte 0x01, 0x10, 0x80, 0x00
    .byte 0x04, 0x04, 0x02, 0x00, 0xfe, 0xfc, 0xf8, 0xf6, 0xf2, 0xf0, 0xf0, 0xee, 0xec, 0xea, 0xe8, 0xe6
    .byte 0xe4, 0xe4, 0xe0, 0xe0, 0xde, 0xdc, 0xda, 0xda, 0xdc, 0xde, 0xe2, 0xe6, 0xf2, 0xf8, 0xfc, 0x02
    .byte 0x08, 0x0e, 0x12, 0x16, 0x18, 0x1a, 0x1c, 0x1c, 0x1c, 0x1e, 0x1e, 0x20, 0x20, 0x22, 0x22, 0x22
    .byte 0x24, 0x24, 0x24, 0x24, 0x22, 0x20, 0x1e, 0x1c, 0x18, 0x12, 0x10, 0x0c, 0x0a, 0x08, 0x08, 0x08
    .byte 0x01, 0x11, 0x80, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x10, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x10, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x10, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x10, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x10, 0x00, 0x00
    .byte 0x18, 0x0a, 0x39, 0x0a, 0x00, 0x00, 0x58, 0x0a, 0x79, 0x0a, 0x40, 0x00, 0x98, 0x0a, 0xb9, 0x0a
    .byte 0x80, 0x00, 0xd8, 0x0a, 0xf9, 0x0a, 0x00, 0x00, 0x18, 0x0b, 0x39, 0x0b, 0x00, 0x00, 0x58, 0x0b
    .byte 0x79, 0x0b, 0x00, 0x00, 0x98, 0x0b, 0xb9, 0x0b, 0x00, 0x00, 0xd8, 0x0b, 0xf9, 0x0b, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x80, 0x00, 0x00
    .byte 0x0c, 0x0a, 0x18, 0x1a, 0x00, 0x20, 0x18, 0x2a, 0x00, 0x00, 0x18, 0x3a, 0x00, 0x00, 0x18, 0x4a
    .byte 0x00, 0x00, 0x18, 0x5a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x6a, 0x0c, 0x6a, 0x18, 0x6a, 0x24, 0x6a
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7a, 0x0c, 0x7a, 0x18, 0x7a, 0x24, 0x7a
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x80, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x98, 0x0b, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x03, 0x80, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x58, 0x0a, 0x00, 0x00, 0x98, 0x0a, 0x00, 0x00, 0xd8, 0x0a, 0x00, 0x00
    .byte 0x18, 0x0b, 0x00, 0x00, 0x58, 0x0b, 0x00, 0x00, 0x98, 0x0b, 0x00, 0x00, 0xd8, 0x0b, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x05, 0x80, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x58, 0x0a, 0x00, 0x00, 0x98, 0x0a, 0x00, 0x00, 0xd8, 0x0a, 0x00, 0x00
    .byte 0x18, 0x0b, 0x00, 0x00, 0x58, 0x0b, 0x00, 0x00, 0x98, 0x0b, 0x00, 0x00, 0xd8, 0x0b, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x09, 0x80, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x58, 0x0a, 0x00, 0x00, 0x98, 0x0a, 0x00, 0x00, 0xd8, 0x0a, 0x00, 0x00
    .byte 0x18, 0x0b, 0x00, 0x00, 0x58, 0x0b, 0x00, 0x00, 0x98, 0x0b, 0x00, 0x00, 0xd8, 0x0b, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x11, 0x80, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x58, 0x0a, 0x00, 0x00, 0x98, 0x0a, 0x00, 0x00, 0xd8, 0x0a, 0x00, 0x00
    .byte 0x18, 0x0b, 0x00, 0x00, 0x58, 0x0b, 0x00, 0x00, 0x98, 0x0b, 0x00, 0x00, 0xd8, 0x0b, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x19, 0x80, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x58, 0x0a, 0x00, 0x00, 0x98, 0x0a, 0x00, 0x00, 0xd8, 0x0a, 0x00, 0x00
    .byte 0x18, 0x0b, 0x00, 0x00, 0x58, 0x0b, 0x00, 0x00, 0x98, 0x0b, 0x00, 0x00, 0xd8, 0x0b, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x31, 0x80, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x58, 0x0a, 0x00, 0x00, 0x98, 0x0a, 0x00, 0x00, 0xd8, 0x0a, 0x00, 0x00
    .byte 0x18, 0x0b, 0x00, 0x00, 0x58, 0x0b, 0x00, 0x00, 0x98, 0x0b, 0x00, 0x00, 0xd8, 0x0b, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x49, 0x80, 0x00, 0x00
    .byte 0x18, 0x0a, 0x00, 0x00, 0x58, 0x0a, 0x00, 0x00, 0x98, 0x0a, 0x00, 0x00, 0xd8, 0x0a, 0x00, 0x00
    .byte 0x18, 0x0b, 0x00, 0x00, 0x58, 0x0b, 0x00, 0x00, 0x98, 0x0b, 0x00, 0x00, 0xd8, 0x0b, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x91, 0x80, 0x00, 0x00
    .byte 0x00, 0x0a, 0x0c, 0x0a, 0x18, 0x0a, 0x24, 0x0a, 0x30, 0x0a, 0x3c, 0x0a, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x10, 0x00, 0x00
    .byte 0x18, 0x0e, 0x18, 0x0c, 0x18, 0x0a, 0x18, 0x08, 0x18, 0x06, 0x18, 0x04, 0x18, 0x02, 0x0c, 0x00
    .byte 0x0c, 0x02, 0x0c, 0x04, 0x0c, 0x06, 0x0c, 0x08, 0x0c, 0x0a, 0x0c, 0x0c, 0x0c, 0x0e, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x10, 0x00, 0x00
    .byte 0x0c, 0x0a, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00, 0x0c, 0x0a, 0x00, 0x00
    .byte 0x18, 0x0a, 0x24, 0x0a, 0x30, 0x0a, 0x00, 0x00, 0x24, 0x0a, 0x30, 0x0a, 0x3c, 0x0a, 0x00, 0x00
    .byte 0x3c, 0x0a, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x10, 0x08, 0x0f
    .byte 0x0c, 0x8a, 0x00, 0x00, 0x4c, 0x8a, 0x00, 0x00, 0x8c, 0x8a, 0x00, 0x00, 0x0c, 0x8a, 0x0c, 0x8a
    .byte 0x0c, 0x8a, 0x0c, 0x8a, 0x00, 0x00, 0x4c, 0x8a, 0x4c, 0x8a, 0x4c, 0x8a, 0x4c, 0x8a, 0x00, 0x00
    .byte 0x8c, 0x8a, 0x8c, 0x8a, 0x8c, 0x8a, 0x8c, 0x8a, 0x00, 0x00, 0x0c, 0x8a, 0x4c, 0x8a, 0x8c, 0x8a
    .byte 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
    .byte 0x01, 0x80, 0x00, 0x00
